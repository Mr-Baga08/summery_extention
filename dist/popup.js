class UniversalSummarizer{constructor(){this.apiKey=":AIzaSyAERk13UdvNIofkk63ND1_chOV0cPVFr-k",this.currentSummary=null,this.currentContent=null,this.initialize()}initialize(){this.setupEventListeners()}setupEventListeners(){document.getElementById("summarize-btn").addEventListener("click",()=>{this.generateSummary()}),document.getElementById("export-pdf").addEventListener("click",()=>{this.exportToPDF()})}async generateSummary(){if("YOUR_API_KEY"!==this.apiKey){this.showStatus("Extracting content from page...","info"),this.showProgress(!0);try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]});const e=await chrome.tabs.sendMessage(t.id,{action:"extractContent"});if(!e.success)throw new Error(e.error||"Failed to extract content");this.currentContent=e.content,this.updateTokenInfo(e.content.content),this.showStatus("Generating AI summary...","info");const s=await this.callGeminiAPI(e.content);this.currentSummary=s,this.displaySummary(s),document.getElementById("export-pdf").disabled=!1,this.showStatus("Summary generated successfully!","success")}catch(t){console.error("Summary generation failed:",t),this.showStatus(`Error: ${t.message}`,"error")}finally{this.showProgress(!1)}}else this.showStatus("Please replace YOUR_API_KEY in popup.js","error")}async callGeminiAPI(t){const e=document.getElementById("summary-length").value,s=this.buildPrompt(t,e),n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:s}]}],generationConfig:{temperature:.7,topK:40,topP:.95,maxOutputTokens:1024}})});if(!n.ok){const t=await n.json();throw new Error(t.error?.message||"API request failed")}return(await n.json()).candidates[0].content.parts[0].text}buildPrompt(t,e){let s=`Please summarize the following ${"youtube"===t.type?"YouTube video content":"web page"}:\n\n`;return s+=`"${t.content.substring(0,5e4)}"\n\n`,s+="5"===e?"Provide the summary in exactly 5 bullet points.\n":"10"===e?"Provide the summary in exactly 10 bullet points.\n":"Provide a comprehensive, detailed summary with sections.\n","youtube"===t.type&&t.hasTranscript&&(s+="Include relevant timestamps from the transcript in format [MM:SS].\n"),"youtube"!==t.type||t.hasTranscript||(s+="Note: No transcript was found. This summary is based on video description and comments.\n"),s}displaySummary(t){const e=document.getElementById("summary-output");"youtube"===this.currentContent.type&&(t=this.addTimestampLinks(t));const s=this.formatSummary(t);e.innerHTML=s,this.addTimestampHandlers()}addTimestampLinks(t){return t.replace(/\[(\d{1,2}):(\d{2})\]/g,'<span class="timestamp" data-minutes="$1" data-seconds="$2">[$1:$2]</span>')}addTimestampHandlers(){document.querySelectorAll(".timestamp").forEach(t=>{t.addEventListener("click",async t=>{const e=60*parseInt(t.target.dataset.minutes,10)+parseInt(t.target.dataset.seconds,10),[s]=await chrome.tabs.query({active:!0,currentWindow:!0});chrome.tabs.sendMessage(s.id,{action:"seekToTime",time:e})})})}formatSummary(t){let e=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^â€¢\s+(.*)$/gm,"<li>$1</li>").replace(/^#\s+(.*)$/gm,"<h3>$1</h3>").replace(/^##\s+(.*)$/gm,"<h4>$1</h4>").replace(/\n/g,"<br>");return e.includes("<li>")&&(e=`<ul>${e.replace(/<br>/g,"")}</ul>`),`<div class="summary-content">${e}</div>`}async exportToPDF(){if(this.currentSummary)try{const{jsPDF:t}=await import("./lib/jspdf.umd.min.js"),e=new t,s=e.internal.pageSize.getWidth(),n=20;e.setFontSize(18),e.text("AI Summary Report",s/2,20,{align:"center"}),e.setFontSize(10),e.text(`Source: ${this.currentContent.url}`,n,35),e.text(`Generated: ${(new Date).toLocaleString()}`,n,42),e.text(`Content Type: ${this.currentContent.type.toUpperCase()}`,n,49);const r=e.splitTextToSize(this.currentSummary,s-2*n);e.setFontSize(12),e.text(r,n,65);const a=`summary_${Date.now()}.pdf`;e.save(a),this.showStatus(`PDF exported as ${a}`,"success")}catch(t){console.error("PDF export error:",t),this.showStatus("PDF export failed.","error")}else this.showStatus("No summary to export","error")}updateTokenInfo(t){const e=document.getElementById("token-info");if(!e)return;const s=t.split(/\s+/).length,n=(t.length,Math.ceil(1.3*s));e.innerHTML=`\n            ðŸ“Š ${s.toLocaleString()} words | \n            ~${n.toLocaleString()} tokens\n        `}showStatus(t,e="info"){const s=document.getElementById("status-bar");s&&(s.textContent=t,s.className=`status-bar ${e}`,"success"===e&&setTimeout(()=>{s.textContent="",s.className="status-bar"},3e3))}showProgress(t){const e=document.getElementById("progress-bar");e&&(e.style.display=t?"block":"none",t&&(e.innerHTML='<div class="progress-fill"></div>'))}}document.addEventListener("DOMContentLoaded",()=>{new UniversalSummarizer});